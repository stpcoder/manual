# 제10장 데이터 구조

## 10.1 개요

본 장은 시스템 내부에서 사용되는 주요 데이터 구조의 상세 명세를 기술한다. 각 데이터 구조의 필드 정의, 자료형, 유효 범위, 용도를 포함한다.

## 10.2 Hole Dict (손상 부위 딕셔너리)

검출된 개별 손상 부위를 나타내는 핵심 데이터 구조이다. 시스템 전반에서 손상 부위의 기본 단위로 사용된다.

### 10.2.1 필드 정의

| 필드명 | 자료형 | 설명 | 비고 |
|--------|--------|------|------|
| id | int | 공간 기반 조각 번호 | 1부터 시작, 재번호 부여 시 변경 |
| contour | numpy.ndarray | OpenCV 윤곽선 배열 | 형상: (N, 1, 2), dtype: int32 |
| bbox | tuple(int, int, int, int) | 바운딩 박스 | (x, y, w, h) 좌상단 좌표 및 크기 |
| area | float | 픽셀 면적 | 윤곽선 내부 면적 (제곱 픽셀) |
| center | tuple(int, int) | 중심 좌표 | (cx, cy) |

### 10.2.2 Python 표현

```python
hole = {
    'id': 1,
    'contour': numpy.array([[[100, 200]], [[150, 200]], [[150, 250]], [[100, 250]]]),
    'bbox': (100, 200, 50, 50),
    'area': 2500.0,
    'center': (125, 225),
}
```

### 10.2.3 생성 시점

extract_individual_holes() 함수에서 이진 마스크의 윤곽선을 추출할 때 생성된다. 이후 assign_spatial_numbers() 함수에서 id 필드가 갱신된다.

## 10.3 Filter Settings Dict (필터 설정 딕셔너리)

검출에 사용할 채널별 필터 조건을 정의하는 데이터 구조이다.

### 10.3.1 최상위 구조

| 필드명 | 자료형 | 설명 | 유효값 |
|--------|--------|------|--------|
| combine_mode | str | 필터 결합 방식 | "AND" 또는 "OR" |
| filters | dict | 채널별 필터 설정 | 아래 참조 |

### 10.3.2 개별 채널 필터 구조

filters 필드 내의 각 채널은 다음 구조를 갖는다.

| 필드명 | 자료형 | 설명 | 유효값 |
|--------|--------|------|--------|
| enabled | bool | 해당 채널 사용 여부 | True 또는 False |
| value | int | 임계값 | 0 - 255 (Tex는 0 - 1000) |
| condition | str | 비교 조건 | "less" 또는 "greater" |

### 10.3.3 지원 채널 목록

| 채널 키 | 채널명 | 색공간 | 기본값 | 기본 조건 | 기본 활성 |
|---------|--------|--------|--------|-----------|-----------|
| S | Saturation | HSV | 30 | less | True |
| L | Lightness | LAB | 200 | greater | True |
| b | b channel | LAB | 138 | less | True |
| Tex | Texture | - | 500 | less | False |
| W | Whiteness | LAB 유도 | 180 | greater | False |

### 10.3.4 필터 적용 논리

combine_mode가 "AND"인 경우, 활성화된 모든 채널의 조건을 동시에 만족하는 픽셀만 검출된다. "OR"인 경우, 활성화된 채널 중 하나 이상의 조건을 만족하는 픽셀이 검출된다.

각 채널의 조건 해석:
- condition이 "less"인 경우: 픽셀 값 < value 이면 조건 만족
- condition이 "greater"인 경우: 픽셀 값 > value 이면 조건 만족

### 10.3.5 Python 표현

```python
filter_settings = {
    'combine_mode': 'AND',
    'filters': {
        'S': {'enabled': True, 'value': 30, 'condition': 'less'},
        'L': {'enabled': True, 'value': 200, 'condition': 'greater'},
        'b': {'enabled': True, 'value': 138, 'condition': 'less'},
        'Tex': {'enabled': False, 'value': 500, 'condition': 'less'},
        'W': {'enabled': False, 'value': 180, 'condition': 'greater'},
    }
}
```

## 10.4 Analysis Results Dict (분석 결과 딕셔너리)

영역 분석(analyze_regions) 함수의 반환값으로, 각 채널에 대한 최적 임계값과 분리도 정보를 포함한다.

### 10.4.1 채널별 분석 결과 구조

| 필드명 | 자료형 | 설명 |
|--------|--------|------|
| threshold | float | 추천 임계값 |
| condition | str | 추천 비교 조건 ("less" 또는 "greater") |
| separation | float | 분리도 점수 (높을수록 구분력이 높음) |
| bg_mean | float | 배경 영역 평균값 |
| bg_std | float | 배경 영역 표준편차 |
| fg_mean | float | 전경 영역 평균값 |
| fg_std | float | 전경 영역 표준편차 |

### 10.4.2 분리도 계산 공식

```
separation = |bg_mean - fg_mean| / (bg_std + fg_std + epsilon)
```

여기서 epsilon은 0으로 나누는 것을 방지하기 위한 미소값이다.

### 10.4.3 임계값 계산 공식

```
threshold = bg_mean + (fg_mean - bg_mean) * 0.2
```

임계값은 배경 쪽에 가중치를 두어 설정된다. 이는 손상 부위를 놓치는 것보다 약간의 오탐지가 허용되는 것이 복원 작업에서 더 유리하기 때문이다.

## 10.5 Region Model (영역 분류 모델)

### 10.5.1 GMM 모델 구조 (v3)

```python
region_model = {
    'type': 'gmm',
    'bg_components': [
        {
            'mean': numpy.ndarray,     # (4,) 형상, [L, a, b, S] 평균
            'cov_inv': numpy.ndarray,  # (4, 4) 형상, 역공분산 행렬
            'weight': float,           # 가중치 (해당 영역의 픽셀 수)
        },
        ...  # N개의 배경 컴포넌트 (선택된 배경 영역 수와 동일)
    ],
    'fg_components': [
        ...  # M개의 전경 컴포넌트 (동일 구조)
    ],
}
```

### 10.5.2 단일 Gaussian 모델 구조 (v2, 하위 호환)

```python
region_model = {
    'type': 'single',
    'bg_mean': numpy.ndarray,      # (4,) 배경 평균
    'fg_mean': numpy.ndarray,      # (4,) 전경 평균
    'bg_cov_inv': numpy.ndarray,   # (4, 4) 배경 역공분산
    'fg_cov_inv': numpy.ndarray,   # (4, 4) 전경 역공분산
}
```

### 10.5.3 특성 벡터

GMM 모델의 특성 벡터는 4차원으로 구성된다.

| 차원 | 채널 | 색공간 | 범위 |
|------|------|--------|------|
| 0 | L | LAB | 0 - 255 |
| 1 | a | LAB | 0 - 255 (중심 128) |
| 2 | b | LAB | 0 - 255 (중심 128) |
| 3 | S | HSV | 0 - 255 |

### 10.5.4 Mahalanobis 거리 계산

특정 픽셀 x와 컴포넌트 c 사이의 Mahalanobis 거리의 제곱은 다음과 같이 계산된다.

```
d^2(x, c) = (x - mu_c)^T * Sigma_c^(-1) * (x - mu_c)
```

여기서:
- x: 4차원 특성 벡터 [L, a, b, S]
- mu_c: 컴포넌트 c의 평균 벡터
- Sigma_c^(-1): 컴포넌트 c의 역공분산 행렬

GMM에서의 최소 거리 분류:
```
dist_bg(x) = min(d^2(x, c) for c in bg_components)
dist_fg(x) = min(d^2(x, c) for c in fg_components)

분류 결과: dist_fg(x) > dist_bg(x) 이면 해당 픽셀은 배경(구멍)으로 분류
```

## 10.6 Layout Piece Dict (레이아웃 조각 딕셔너리)

LayoutViewer 내부에서 사용되는 배치된 조각의 데이터 구조이다.

### 10.6.1 필드 정의

| 필드명 | 자료형 | 설명 |
|--------|--------|------|
| index | int | 배열 인덱스 |
| hole_id | int | 조각 번호 (Hole Dict의 id와 대응) |
| path | QPainterPath | 렌더링용 경로 객체 |
| bounds | QRectF | 바운딩 박스 |
| width | float | 디스플레이 픽셀 너비 |
| height | float | 디스플레이 픽셀 높이 |
| pack_height | float | 라벨 공간을 포함한 높이 |
| label_offset | float | 라벨 오프셋 |
| x | float | 페이지 내 X 좌표 (mm) |
| y | float | 페이지 내 Y 좌표 (mm) |
| page | int | 페이지 번호 (0부터 시작) |
| custom_scale_x | float 또는 None | 개별 X축 커스텀 스케일 |
| custom_scale_y | float 또는 None | 개별 Y축 커스텀 스케일 |
| svg_path | str | 원본 SVG path 문자열 |

## 10.7 Selection Mode (선택 모드 열거값)

SVGOverlayViewer에서 사용하는 선택 모드 열거값이다.

| 모드 | 값 | 설명 |
|------|---|------|
| NONE | 0 | 일반 모드 (패닝/줌) |
| BACKGROUND | 1 | 배경(구멍) 영역 선택 |
| FOREGROUND | 2 | 전경(그림) 영역 선택 |
| MIN_AREA | 3 | 최소 면적 기준 선택 |
| MAX_AREA | 4 | 최대 면적 기준 선택 |
| DESELECT_AREA | 5 | 드래그 영역 내 구멍 일괄 해제 |

## 10.8 테마 색상 정의

다크 테마에서 사용되는 색상 팔레트이다.

| 키 | 색상 코드 | 용도 |
|----|----------|------|
| background | #1E1E1E | 메인 배경 |
| surface | #252526 | 패널 배경 |
| surface_light | #2D2D30 | 밝은 패널 |
| border | #3E3E42 | 테두리 |
| text | #D4D4D4 | 기본 텍스트 |
| text_dim | #808080 | 비활성 텍스트 |
| accent | #0E639C | 강조색 (버튼) |
| accent_hover | #1177BB | 호버 강조 |
| success | #4EC9B0 | 성공 (활성 구멍 색상) |
| error | #F14C4C | 오류 (비활성 구멍 색상) |
| warning | #CCA700 | 경고 |

## 10.9 시그널/슬롯 연결 전체 맵

### 10.9.1 MainWindow 시그널 연결

아래에 MainWindow._connect_signals()에서 수행되는 모든 시그널-슬롯 연결을 기술한다.

발신자: ControlPanel
| 시그널 | 수신 슬롯 |
|--------|----------|
| image_loaded(str) | MainWindow._on_image_loaded |
| run_detection() | MainWindow._run_detection |
| save_requested() | MainWindow._save_all_results |
| eyedropper_activated() | MainWindow._activate_eyedropper |
| select_background() | MainWindow._start_bg_selection |
| select_foreground() | MainWindow._start_fg_selection |
| analyze_regions() | MainWindow._analyze_regions |
| apply_filter() | MainWindow._apply_filter |
| select_min_area() | MainWindow._start_min_area_selection |
| select_max_area() | MainWindow._start_max_area_selection |

발신자: AreaSelector
| 시그널 | 수신 슬롯 |
|--------|----------|
| select_deselect_area() | MainWindow._start_deselect_area_selection |

발신자: SVGOverlayViewer
| 시그널 | 수신 슬롯 |
|--------|----------|
| color_picked(str) | MainWindow._on_color_picked |
| hole_clicked(int) | MainWindow._on_hole_clicked |
| region_selected(int, tuple) | MainWindow._on_region_selected |
| area_selected(int, int) | MainWindow._on_area_selected |
| deselect_area_selected(tuple) | MainWindow._on_deselect_area |

발신자: QTabWidget
| 시그널 | 수신 슬롯 |
|--------|----------|
| currentChanged(int) | MainWindow._on_tab_changed |

발신자: LayoutViewer
| 시그널 | 수신 슬롯 |
|--------|----------|
| loading_started() | MainWindow._on_layout_loading_started |
| loading_finished() | MainWindow._on_layout_loading_finished |

### 10.9.2 Worker 시그널 (동적 연결)

DetectionWorker 인스턴스 생성 시:
| 시그널 | 수신 슬롯 |
|--------|----------|
| finished(list, list) | MainWindow._on_detection_finished |
| error(str) | MainWindow._on_detection_error |
| progress(int, str) | MainWindow._on_detection_progress |

AnalysisWorker 인스턴스 생성 시:
| 시그널 | 수신 슬롯 |
|--------|----------|
| finished(dict) | MainWindow._on_analysis_finished |
| error(str) | MainWindow._on_analysis_error |

### 10.9.3 ControlPanel 내부 시그널 전달

ControlPanel은 하위 위젯의 시그널을 자신의 시그널로 전달(relay)한다.

| 원본 위젯 시그널 | 전달되는 ControlPanel 시그널 |
|-----------------|---------------------------|
| ImageDropZone.image_loaded | ControlPanel.image_loaded |
| RegionSelector.select_background | ControlPanel.select_background |
| RegionSelector.select_foreground | ControlPanel.select_foreground |
| RegionSelector.analyze_requested | ControlPanel.analyze_regions |
| FilterPanel.apply_filter | ControlPanel.apply_filter |
| AreaSelector.select_min_area | ControlPanel.select_min_area |
| AreaSelector.select_max_area | ControlPanel.select_max_area |
