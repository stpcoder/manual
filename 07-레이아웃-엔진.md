# 제7장 레이아웃 엔진

## 7.1 개요

레이아웃 엔진은 검출된 손상 부위의 형상을 지정된 용지 크기 위에 최적으로 배치하여, 레이저 커터 호환 SVG 벡터 파일을 생성하는 모듈이다. 핵심 알고리즘으로 Skyline Bin Packing을 채택하고 있으며, 다중 페이지 자동 분할, 라벨링, 실측 캘리브레이션 기능을 포함한다.

관련 소스 파일은 다음과 같다.

- main/create_cutting_layout.py -- 알고리즘 계층의 레이아웃 생성 모듈
- gui_app/src/widgets/layout_viewer.py -- GUI 계층의 레이아웃 시각화 위젯

## 7.2 Skyline Bin Packing 알고리즘

### 7.2.1 알고리즘 원리

Skyline Bin Packing은 2차원 직사각형 패킹 문제를 해결하는 알고리즘으로, 용지의 상단 윤곽선(skyline)을 프로파일로 관리하면서 각 조각을 최적 위치에 배치한다.

용지를 아래에서 위로 채워나가는 방식으로, 각 시점에서 용지의 "높이 프로파일"은 다수의 수평 세그먼트로 표현된다.

### 7.2.2 초기 상태

```
skyline = [(x=0, y=0, width=용지_너비)]
```

초기 상태에서 skyline은 용지 바닥 전체를 나타내는 단일 세그먼트로 구성된다.

### 7.2.3 배치 과정

각 조각에 대해 다음 과정을 수행한다.

1. 모든 skyline 세그먼트에 대해, 해당 위치에 조각이 배치 가능한지 판정한다.
   - 조건 1: x + piece_width <= page_width (용지 너비 초과 여부)
   - 조건 2: 해당 범위에 걸치는 모든 세그먼트의 최대 y값을 산출한다.
   - 조건 3: max_y + piece_height <= page_height (용지 높이 초과 여부)

2. 배치 가능한 위치 중 최소 y값(가장 낮은 위치)을 갖는 위치를 선택한다.

3. 선택된 위치에 조각을 배치하고 skyline을 갱신한다.
   - 배치 범위에 해당하는 기존 세그먼트를 제거한다.
   - 새 세그먼트 (x, y + piece_height, piece_width)를 추가한다.
   - 인접한 동일 높이의 세그먼트를 병합한다.

4. 현재 페이지에 배치할 수 없는 경우, 새 페이지를 생성하여 배치를 재시도한다.

### 7.2.4 배치 순서

조각은 면적이 큰 순서대로 배치한다. 이는 큰 조각을 먼저 배치함으로써 전체 공간 활용률을 높이기 위함이다.

### 7.2.5 배치 시각화 예시

```
배치 전:
+----------------------------------+
|                                  |
|                                  |
|                                  |
|__________________________________|  skyline: y=0, 전체 너비

1번 조각 배치 후:
+----------------------------------+
|                                  |
|                                  |
|  +------+                        |
|  |  #1  |________________________|  skyline 갱신

2번 조각 배치 후:
+----------------------------------+
|                                  |
|  +------+  +----+                |
|  |  #1  |  | #2 |_______________|  skyline 갱신
|  |      |  +----+                |
```

## 7.3 BinPacker2D 클래스

### 7.3.1 클래스 정의

BinPacker2D는 Skyline Bin Packing 알고리즘을 구현하는 핵심 클래스이다.

주요 속성:
- width: 용지 유효 너비 (mm)
- height: 용지 유효 높이 (mm)
- skyline: 현재 높이 프로파일 세그먼트 리스트

주요 메서드:
- pack_piece(piece_width, piece_height): 단일 조각을 배치하고 (x, y) 좌표를 반환한다.

### 7.3.2 용지 유효 영역 계산

```
유효_너비 = 용지_너비 - (여백 * 2)
유효_높이 = 용지_높이 - (여백 * 2)
```

여백(margin)은 용지 양쪽에 동일하게 적용되며, 조각은 유효 영역 내에서만 배치된다.

## 7.4 용지 크기 프리셋

시스템이 제공하는 용지 크기 프리셋은 다음과 같다.

| 프리셋 명칭 | 너비 (mm) | 높이 (mm) |
|------------|----------|----------|
| Custom | 100 | 290 |
| A4 | 210 | 297 |
| A3 | 297 | 420 |
| A2 | 420 | 594 |
| B4 | 250 | 353 |
| B3 | 353 | 500 |

Custom 프리셋 선택 시 너비와 높이를 사용자가 직접 입력할 수 있다.

## 7.5 레이아웃 매개변수

### 7.5.1 여백 (Margin)

용지 가장자리로부터의 안쪽 여백이다. 단위는 밀리미터(mm)이며, 설정 범위는 0mm부터 50mm까지이다. 기본값은 10mm이다.

### 7.5.2 스케일 (Scale)

검출된 조각의 픽셀 크기를 실제 밀리미터 크기로 변환하는 배율이다. X축과 Y축 독립적으로 설정 가능하며, 설정 범위는 0.1배부터 10.0배까지이다.

스케일 계산:
```
조각_너비_mm = 조각_너비_px * scale_x
조각_높이_mm = 조각_높이_px * scale_y
```

### 7.5.3 테두리 (Border)

각 조각 주위에 추가되는 절단선 여유분이다. 단위는 밀리미터이며, 설정 범위는 0mm부터 5mm까지이다.

### 7.5.4 간격 (Spacing)

인접한 조각 사이의 최소 간격이다. 단위는 밀리미터이며, 설정 범위는 0mm부터 20mm까지이다. 기본값은 2.0mm이다.

## 7.6 실측 캘리브레이션

### 7.6.1 기능 설명

스캔 이미지의 해상도(DPI)를 정확히 알 수 없는 경우, 특정 조각의 실제 물리적 치수를 입력하여 전체 스케일을 역산하는 기능이다.

### 7.6.2 캘리브레이션 절차

1. Layout 탭에서 임의의 조각을 마우스로 클릭하여 선택한다.
2. 선택된 조각의 정보(번호, 현재 크기)가 상단에 표시된다.
3. "Real: W __ cm  H __ cm" 입력란에 해당 조각의 실제 물리적 치수를 센티미터 단위로 입력한다.
4. "Apply" 버튼을 클릭한다.

### 7.6.3 스케일 역산 공식

```
입력된_너비_mm = 입력된_너비_cm * 10
입력된_높이_mm = 입력된_높이_cm * 10

new_scale_x = 입력된_너비_mm / 조각_너비_px
new_scale_y = 입력된_높이_mm / 조각_높이_px
```

역산된 스케일은 해당 조각뿐만 아니라 전체 레이아웃에 적용될 수 있으며, 개별 조각에만 적용하는 것도 가능하다.

## 7.7 다중 페이지 처리

### 7.7.1 자동 페이지 분할

단일 페이지에 모든 조각을 배치할 수 없는 경우, 시스템은 자동으로 새 페이지를 생성하여 나머지 조각을 배치한다. 페이지 번호는 1부터 순차적으로 부여된다.

### 7.7.2 페이지 네비게이션

GUI에서는 이전 페이지([<]) 및 다음 페이지([>]) 버튼과 현재 페이지 표시("Page 1/3")를 통해 다중 페이지를 탐색할 수 있다.

### 7.7.3 배치 실패 조각

개별 조각의 크기가 용지의 유효 영역을 초과하는 경우, 해당 조각은 배치에 실패하며 failed_pieces 목록에 기록된다. 이 경우 더 큰 용지를 선택하거나 스케일을 축소하여 해결할 수 있다.

## 7.8 라벨링

### 7.8.1 라벨 배치 규칙

각 조각에는 해당 조각의 번호가 라벨로 표시된다. 라벨은 조각의 외부에 배치되며, 다른 조각과 겹치지 않는 위치를 자동으로 선택한다.

라벨 위치 선택 우선순위:
1. 조각 상단
2. 조각 우측
3. 조각 하단
4. 조각 좌측

### 7.8.2 라벨 크기

SVG 출력에서 라벨의 크기는 0.8mm로 설정되며, 라벨과 조각 사이의 간격은 조정 가능하다.

## 7.9 SVG 출력 형식

### 7.9.1 파일 구조

각 페이지는 독립된 SVG 파일로 출력되며, 파일명은 다음 규칙을 따른다.

```
layout_page_1.svg
layout_page_2.svg
layout_page_3.svg
```

### 7.9.2 SVG 내용 구성

각 SVG 파일은 다음 요소를 포함한다.

- 용지 영역을 나타내는 직사각형
- 여백 경계를 나타내는 점선 직사각형
- 각 조각의 윤곽선 경로(path 요소)
- 각 조각의 번호 라벨(text 요소)

### 7.9.3 좌표 체계

SVG 파일의 좌표 체계는 밀리미터 단위이며, viewBox 속성을 통해 용지 크기와 1:1로 대응된다. 이를 통해 레이저 커터 소프트웨어에서 별도의 스케일 변환 없이 직접 사용할 수 있다.

## 7.10 PNG 미리보기 출력

SVG 파일 외에 300 DPI의 PNG 미리보기 이미지도 함께 생성된다. PNG 파일은 시각적 확인 용도이며, 레이저 커팅에는 SVG 파일을 사용한다.

## 7.11 레이아웃 메타데이터

레이아웃 생성 시 다음 메타데이터가 기록된다.

- 각 조각의 페이지 번호, 배치 좌표(x_mm, y_mm), 크기(width_mm, height_mm)
- 적용된 스케일 계수(scale_x, scale_y)
- 개별 조각 커스텀 스케일(custom_scale_x, custom_scale_y)
- 배치 실패 조각 목록(failed_pieces)
- 총 페이지 수

이 메타데이터는 info.json 파일에 포함되어 저장된다. 상세 형식은 제8장 출력 형식을 참조한다.

## 7.12 NFP 기반 패킹 (실험적)

### 7.12.1 개요

nfp_packer.py 모듈은 No-Fit Polygon(NFP) 알고리즘을 이용한 비직사각형 패킹을 구현한다. 직사각형 바운딩 박스 대신 조각의 실제 폴리곤 형상을 고려하여 배치함으로써, 이론적으로 더 높은 공간 활용률을 달성할 수 있다.

### 7.12.2 현재 상태

본 모듈은 실험적 단계에 있으며, CLI에서만 사용 가능하다. GUI의 LayoutViewer와는 미통합 상태이다. Shapely 라이브러리를 기반으로 폴리곤 충돌 검사를 수행한다.

## 7.13 성능 특성

| 조각 수 | 레이아웃 소요 시간 | 비고 |
|---------|-------------------|------|
| 50개 미만 | 0.5초 미만 | |
| 100개 | 약 1초 | |
| 300개 | 약 2초 | |

GUI에서는 300ms debounce가 적용되어, 설정 변경 후 300ms 이내의 추가 변경은 마지막 변경만 반영된다. 이를 통해 불필요한 재계산을 방지한다.
