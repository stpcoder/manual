# 제2장 시스템 구조

## 2.1 아키텍처 개요

본 시스템은 3계층(Three-Layer) 아키텍처를 채택하고 있으며, 각 계층은 명확한 책임 분리 원칙에 따라 설계되었다.

```
+-------------------------------------------------------------------+
|                     GUI 계층 (GUI Layer)                            |
|                                                                     |
|   MainWindow (app.py)                                               |
|     - 애플리케이션 상태 관리                                          |
|     - 시그널/슬롯 연결                                               |
|     - 메뉴 및 저장 처리                                              |
|                                                                     |
|   위젯 (Widgets)                      워커 (Workers)                 |
|     SVGOverlayViewer                    DetectionWorker              |
|     LayoutViewer                        AnalysisWorker               |
|     ControlPanel                                                    |
|     FilterPanel                                                     |
|     RegionSelector                                                  |
|     AreaSelector                                                    |
|     ImageDropZone                                                   |
|     LoadingOverlay                                                  |
+-------------------------------------------------------------------+
|                     코어 계층 (Core Layer)                           |
|                                                                     |
|   Detector (detector.py)               Theme (theme.py)             |
|     - detect()                           - 다크 테마 스타일시트       |
|     - detect_with_filters()              - apply_theme()            |
|     - analyze_regions()                                             |
+-------------------------------------------------------------------+
|                  알고리즘 계층 (Algorithm Layer)                      |
|                                                                     |
|   extract_whiteness_based.py   spatial_numbering.py                 |
|     - detect_whiteness()         - assign_spatial_numbers()         |
|     - extract_individual_holes() - cluster_by_grid()                |
|                                                                     |
|   create_cutting_layout.py     create_restoration_guide.py          |
|     - BinPacker2D (Skyline)      - create_restoration_guide()      |
|     - pack_pieces_to_pages()     - export_csv()                    |
|                                                                     |
|   auto_threshold.py            restoration_workflow.py (CLI)        |
|     - analyze_image_colors()     - 전체 파이프라인 오케스트레이션     |
|                                                                     |
|   nfp_packer.py                multi_image_processor.py             |
|     - NFP 기반 패킹              - 타일 이미지 병합                  |
+-------------------------------------------------------------------+
```

## 2.2 설계 원칙

### 2.2.1 계층 분리

GUI 계층은 알고리즘 계층을 직접 호출하지 않으며, 반드시 코어 계층의 Detector 클래스를 통해 접근한다. 이로써 알고리즘 모듈의 인터페이스가 변경되더라도 GUI 코드의 수정을 최소화할 수 있다.

### 2.2.2 비동기 처리

이미지 분석, 영역 분석 등 연산 비용이 높은 작업은 QThread 기반의 Worker 클래스를 통해 백그라운드 스레드에서 실행한다. 이를 통해 GUI의 응답성을 보장한다.

### 2.2.3 시그널/슬롯 기반 느슨한 결합

모듈 간 통신은 PyQt6의 시그널/슬롯 메커니즘을 통해 이루어지며, 직접적인 함수 호출 의존성을 최소화한다.

### 2.2.4 단일 책임 원칙

각 위젯 및 모듈은 하나의 명확한 역할만을 수행하도록 설계되었다.

## 2.3 디렉토리 구조

```
Recognition_of_damaged_areas_in_ancient_documents/
|
|-- README.md                              프로젝트 소개 문서
|-- requirements.txt                       전체 의존성 목록
|-- build_exe.spec                         PyInstaller 빌드 설정
|
|-- docs/
|   |-- DESIGN.md                          상세 설계 문서
|   +-- manual/                            공식 문서 (본 문서)
|
|-- gui_app/                               GUI 애플리케이션
|   |-- requirements.txt                   GUI 전용 의존성
|   +-- src/
|       |-- main.py                        애플리케이션 진입점
|       |-- app.py                         MainWindow 오케스트레이터
|       |-- theme.py                       다크 테마 스타일시트
|       |
|       |-- core/
|       |   |-- __init__.py
|       |   +-- detector.py                검출 엔진 래퍼 클래스
|       |
|       |-- widgets/
|       |   |-- __init__.py
|       |   |-- svg_overlay_viewer.py      이미지 뷰어 (SVG 오버레이)
|       |   |-- layout_viewer.py           커팅 레이아웃 시각화
|       |   |-- control_panel.py           좌측 사이드바 컨트롤
|       |   |-- filter_panel.py            채널별 필터 설정
|       |   |-- region_selector.py         배경/전경 영역 선택
|       |   |-- area_selector.py           면적 필터 및 경계 검출
|       |   |-- image_drop_zone.py         드래그 앤 드롭 이미지 로더
|       |   |-- color_picker.py            레거시 필터 설정 (호환용)
|       |   +-- loading_overlay.py         로딩 스피너 오버레이
|       |
|       +-- workers/
|           |-- __init__.py
|           |-- detection_worker.py        검출 백그라운드 스레드
|           +-- analysis_worker.py         영역 분석 백그라운드 스레드
|
|-- main/                                  핵심 알고리즘 모듈 (CLI 호환)
|   |-- __init__.py
|   |-- extract_whiteness_based.py         손상 검출 엔진 (HSV/LAB/Whiteness)
|   |-- spatial_numbering.py               그리드 기반 공간 번호 부여
|   |-- create_cutting_layout.py           Skyline Bin Packing 레이아웃
|   |-- create_restoration_guide.py        복원 가이드 이미지 생성
|   |-- restoration_workflow.py            CLI 통합 워크플로우
|   |-- auto_threshold.py                  자동 임계값 추천
|   |-- nfp_packer.py                      NFP 기반 패킹 (실험적)
|   |-- multi_image_processor.py           분할 스캔 타일 병합
|   |-- batch_process_all.py               배치 처리 유틸리티
|   |-- texture_filter_test.py             텍스처 분석 테스트
|   +-- verify_svg_alignment.py            SVG 정렬 검증
|
|-- plan/                                  개발 계획 문서
+-- worklog/                               개발 이력 기록
```

## 2.4 모듈 의존 관계

### 2.4.1 호출 계층도

아래에 주요 모듈 간 호출 관계를 기술한다. 화살표(-->)는 호출 방향을 나타낸다.

```
MainWindow (app.py)
    |
    +--> Detector (core/detector.py)
    |       |
    |       +--> extract_whiteness_based.detect_whiteness()
    |       +--> extract_whiteness_based.extract_individual_holes()
    |       +--> spatial_numbering.assign_spatial_numbers()
    |       +--> extract_whiteness_based.contour_to_svg_path()
    |
    +--> DetectionWorker (workers/detection_worker.py)
    |       |
    |       +--> Detector.detect() 또는 Detector.detect_with_filters()
    |
    +--> AnalysisWorker (workers/analysis_worker.py)
    |       |
    |       +--> Detector.analyze_regions()
    |
    +--> SVGOverlayViewer (widgets/svg_overlay_viewer.py)
    |
    +--> LayoutViewer (widgets/layout_viewer.py)
    |       |
    |       +--> create_cutting_layout.BinPacker2D
    |       +--> create_cutting_layout.pack_pieces_to_pages()
    |
    +--> create_restoration_guide.create_restoration_guide()
```

### 2.4.2 CLI 호출 계층도

```
restoration_workflow.py (CLI 진입점)
    |
    +--> extract_whiteness_based.detect_whiteness()
    +--> extract_whiteness_based.extract_individual_holes()
    +--> spatial_numbering.assign_spatial_numbers()
    +--> create_cutting_layout.pack_pieces_to_pages()
    +--> create_cutting_layout.create_cutting_layout_svg()
    +--> create_restoration_guide.create_restoration_guide()
```

## 2.5 GUI 레이아웃 구조

```
MainWindow
|-- MenuBar
|   |-- File: 열기(Ctrl+O), 저장(Ctrl+S), 세션 저장(Ctrl+Shift+S),
|   |         세션 불러오기(Ctrl+Shift+O), 종료(Ctrl+Q)
|   +-- View: 확대(Ctrl++), 축소(Ctrl+-), 화면 맞춤(Ctrl+0)
|
|-- StatusBar
|
+-- CentralWidget
    +-- QSplitter (수평 분할)
        |
        |-- ControlPanel (좌측, 고정 너비 280px)
        |   |-- ImageDropZone         이미지 드래그 앤 드롭 영역
        |   |-- RegionSelector        배경/전경 영역 선택 버튼
        |   |-- FilterPanel           채널별 필터 임계값 설정
        |   |-- AreaSelector          최소/최대 면적 필터
        |   |-- [Save Results] 버튼
        |   +-- Status 표시           "Holes: 297 | Active: 250"
        |
        +-- QTabWidget (우측, 탭 전환)
            |
            |-- Tab "Detection"
            |   |-- SearchBar (검색란 + Go + Re-number + Fit 버튼)
            |   +-- SVGOverlayViewer (이미지 + SVG 오버레이 뷰어)
            |
            +-- Tab "Layout"
                +-- LayoutViewer (커팅 레이아웃 시각화)
                    +-- LoadingOverlay (로딩 중 표시)
```

## 2.6 데이터 흐름 개요

본 시스템의 주요 데이터 흐름은 다음의 5단계로 구성된다.

1단계: 이미지 로드
- 사용자가 이미지를 드래그 앤 드롭 또는 파일 대화상자를 통해 로드한다.
- 시스템이 이미지를 표시하고 구멍 색상을 자동 추출한다.

2단계: 영역 분석 (선택적)
- 사용자가 구멍 영역과 그림 영역을 각각 다수 지정한다.
- 시스템이 GMM(Gaussian Mixture Model)을 학습하여 분류 모델을 구축한다.

3단계: 손상 검출
- 필터 설정 또는 학습된 GMM 모델을 기반으로 손상 부위를 검출한다.
- 검출된 각 손상 부위에 공간 기반 번호를 부여한다.
- 각 손상 부위의 윤곽선을 SVG 벡터로 변환한다.

4단계: 레이아웃 생성
- Skyline Bin Packing 알고리즘으로 용지 위에 조각을 최적 배치한다.
- 다수의 페이지가 필요한 경우 자동으로 페이지를 분할한다.

5단계: 결과 저장
- 검출 마스크, 비교 이미지, 개별 SVG 벡터 파일을 저장한다.
- 커팅 레이아웃 SVG/PNG 파일을 저장한다.
- 복원 가이드 이미지 및 좌표 CSV 파일을 저장한다.
- 메타데이터를 info.json으로 저장한다.

## 2.7 소스 코드 통계

| 구분 | 파일 수 | 총 코드 행 수 |
|------|---------|-------------|
| GUI 계층 | 12 | 약 4,000행 |
| 코어 계층 | 2 | 약 1,070행 |
| 알고리즘 계층 | 11 | 약 6,000행 |
| 설정/빌드 | 2 | 약 100행 |
| 합계 | 27 | 약 12,500행 |
