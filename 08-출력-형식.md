# 제8장 출력 형식

## 8.1 개요

본 시스템은 결과 저장 시 다음의 디렉토리 구조와 파일 형식으로 출력물을 생성합니다. 모든 출력물은 사용자가 지정한 출력 폴더 하위에 생성됩니다.

## 8.2 출력 디렉토리 구조

```
[출력 폴더]/
|
|-- detection/
|   |-- mask.png                       검출 이진 마스크
|   |-- comparison.png                 원본 이미지 + 윤곽선 오버레이
|   +-- svg_vectors/                   개별 SVG 벡터 파일
|       |-- hole_001.svg
|       |-- hole_002.svg
|       +-- ...
|
|-- cutting_layout/
|   |-- layout_page_1.svg             레이저 커터용 SVG (1페이지)
|   |-- layout_page_1.png             미리보기 PNG (1페이지)
|   |-- layout_page_2.svg             레이저 커터용 SVG (2페이지)
|   |-- layout_page_2.png             미리보기 PNG (2페이지)
|   +-- ...
|
|-- restoration_guide/
|   |-- restoration_guide.png         번호 오버레이 가이드 이미지
|   +-- piece_locations.csv           조각 좌표 데이터
|
+-- info.json                          전체 메타데이터
```

## 8.3 검출 결과 (detection/)

### 8.3.1 mask.png

검출된 손상 부위를 이진 마스크로 표현한 이미지입니다.

- 형식: PNG, 8비트 단일 채널
- 크기: 원본 이미지와 동일
- 값 범위: 0(배경) 또는 255(손상 부위)
- 용도: 검출 결과의 시각적 확인, 후처리 분석

### 8.3.2 comparison.png

원본 이미지 위에 검출된 손상 부위의 윤곽선을 오버레이한 비교 이미지입니다.

- 형식: PNG, 24비트 RGB
- 크기: 원본 이미지와 동일
- 윤곽선 색상: 녹색(활성 조각), 적색(비활성 조각)
- 용도: 검출 정확도의 시각적 검증

### 8.3.3 svg_vectors/ 디렉토리

검출된 각 손상 부위의 윤곽선을 개별 SVG 벡터 파일로 저장한 것입니다.

- 파일명 규칙: hole_NNN.svg (NNN은 3자리 조각 번호, 예: hole_001.svg)
- 좌표 체계: 원본 이미지의 픽셀 좌표
- 내용: SVG path 요소로 구성된 윤곽선

개별 SVG 파일의 구조:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="x y width height"
     width="width_mm" height="height_mm">
  <path d="M x1,y1 L x2,y2 L x3,y3 ... Z"
        fill="none" stroke="black" stroke-width="0.1"/>
</svg>
```

## 8.4 커팅 레이아웃 (cutting_layout/)

### 8.4.1 layout_page_N.svg

레이저 커터에서 직접 사용할 수 있는 벡터 레이아웃 파일입니다.

- 형식: SVG (Scalable Vector Graphics)
- 좌표 단위: 밀리미터(mm)
- viewBox: 용지 크기와 1:1 대응
- 내용 구성:
  - 용지 영역 직사각형
  - 여백 경계 점선
  - 각 조각의 윤곽선 경로(path)
  - 각 조각의 번호 라벨(text)

### 8.4.2 layout_page_N.png

레이아웃의 미리보기용 래스터 이미지입니다.

- 형식: PNG
- 해상도: 300 DPI
- 용도: 시각적 확인 전용 (레이저 커팅에는 SVG 사용)

## 8.5 복원 가이드 (restoration_guide/)

### 8.5.1 restoration_guide.png

원본 이미지 위에 각 손상 부위의 번호를 오버레이한 가이드 이미지입니다.

- 형식: PNG
- 크기: 원본 이미지와 동일
- 번호 표시: 각 조각의 중심 위치에 해당 번호를 표시
- 용도: 커팅된 보충 용지 조각을 원본 작품의 정확한 위치에 부착하기 위한 참조

커팅 레이아웃의 조각 번호와 복원 가이드의 위치 번호는 1:1로 대응되므로, 레이아웃에서 1번으로 커팅된 조각은 가이드에서 1번 위치에 부착합니다.

### 8.5.2 piece_locations.csv

각 조각의 좌표 데이터를 CSV(Comma-Separated Values) 형식으로 기록한 파일입니다.

열 구성:

| 열 명칭 | 자료형 | 설명 |
|---------|--------|------|
| piece_id | 정수 | 조각 번호 |
| bbox_x | 정수 | 바운딩 박스 좌상단 X 좌표 (px) |
| bbox_y | 정수 | 바운딩 박스 좌상단 Y 좌표 (px) |
| bbox_w | 정수 | 바운딩 박스 너비 (px) |
| bbox_h | 정수 | 바운딩 박스 높이 (px) |
| center_x | 정수 | 중심점 X 좌표 (px) |
| center_y | 정수 | 중심점 Y 좌표 (px) |
| area | 실수 | 면적 (px^2) |

예시:
```csv
piece_id,bbox_x,bbox_y,bbox_w,bbox_h,center_x,center_y,area
1,100,200,50,30,125,215,1234.5
2,300,150,40,45,320,172,1456.0
3,500,80,60,25,530,92,1089.3
```

## 8.6 메타데이터 (info.json)

### 8.6.1 개요

전체 처리 결과의 메타데이터를 JSON 형식으로 기록한 파일입니다. 입력 이미지 정보, 검출 설정, 레이아웃 설정, 배치 데이터를 포함합니다.

### 8.6.2 스키마 정의

```json
{
    "image_path": "(문자열) 입력 이미지 파일 경로",
    "image_size": ["(정수) 너비", "(정수) 높이"],
    "total_holes": "(정수) 검출된 전체 손상 부위 수",
    "active_holes": "(정수) 활성화된 손상 부위 수",

    "detection_settings": {
        "filter_settings": {
            "combine_mode": "(문자열) AND 또는 OR",
            "filters": {
                "S": {
                    "enabled": "(논리값) 활성 여부",
                    "value": "(정수) 임계값",
                    "condition": "(문자열) less 또는 greater"
                },
                "L": { "(동일 구조)" },
                "b": { "(동일 구조)" },
                "Tex": { "(동일 구조)" },
                "W": { "(동일 구조)" }
            }
        },
        "min_area": "(정수) 최소 면적 (px^2)",
        "max_area": "(정수) 최대 면적 (px^2)",
        "boundary_detection": "(논리값) 작품 경계 검출 사용 여부"
    },

    "layout_settings": {
        "paper_size": "(문자열) 용지 프리셋 명칭",
        "paper_width_mm": "(실수) 용지 너비 (mm)",
        "paper_height_mm": "(실수) 용지 높이 (mm)",
        "margin_mm": "(실수) 여백 (mm)",
        "scale_x": "(실수) X축 스케일",
        "scale_y": "(실수) Y축 스케일",
        "spacing_mm": "(실수) 조각 간 간격 (mm)"
    },

    "layout_data": [
        {
            "piece_index": "(정수) 배열 인덱스",
            "hole_id": "(정수) 조각 번호",
            "page": "(정수) 페이지 번호 (0부터 시작)",
            "x_mm": "(실수) 배치 X 좌표 (mm)",
            "y_mm": "(실수) 배치 Y 좌표 (mm)",
            "width_mm": "(실수) 조각 너비 (mm)",
            "height_mm": "(실수) 조각 높이 (mm)"
        }
    ],

    "pages": "(정수) 총 페이지 수",
    "failed_pieces": ["(정수 배열) 배치 실패한 조각 번호 목록"],
    "created_at": "(문자열) 생성 일시 (ISO 8601 형식)"
}
```

### 8.6.3 실제 출력 예시

```json
{
    "image_path": "datasets/document_001.tif",
    "image_size": [7216, 5412],
    "total_holes": 297,
    "active_holes": 250,
    "detection_settings": {
        "filter_settings": {
            "combine_mode": "AND",
            "filters": {
                "S": {"enabled": true, "value": 30, "condition": "less"},
                "L": {"enabled": true, "value": 200, "condition": "greater"},
                "b": {"enabled": true, "value": 138, "condition": "less"}
            }
        },
        "min_area": 100,
        "max_area": 500000,
        "boundary_detection": true
    },
    "layout_settings": {
        "paper_size": "A4",
        "paper_width_mm": 210,
        "paper_height_mm": 297,
        "margin_mm": 10,
        "scale_x": 1.0,
        "scale_y": 1.0,
        "spacing_mm": 2.0
    },
    "layout_data": [
        {
            "piece_index": 0,
            "hole_id": 1,
            "page": 0,
            "x_mm": 10.5,
            "y_mm": 20.3,
            "width_mm": 15.2,
            "height_mm": 8.7
        }
    ],
    "pages": 3,
    "failed_pieces": [],
    "created_at": "2026-01-15T14:30:00"
}
```

## 8.7 세션 파일 (.session.json)

### 8.7.1 개요

세션 파일은 현재 작업 상태를 완전히 저장하여 이후 복원할 수 있도록 하는 JSON 파일입니다. info.json이 최종 결과물의 메타데이터인 반면, 세션 파일은 작업 중간 상태를 포함합니다.

### 8.7.2 버전 이력

| 버전 | 주요 변경사항 |
|------|-------------|
| v1 | 기본 상태 저장 (이미지, 구멍, 필터 설정) |
| v2 | 단일 Gaussian 모델 추가, 단일 배경/전경 영역 |
| v3 | GMM 모델(다중 컴포넌트) 추가, 다중 배경/전경 영역 리스트 |

시스템은 v1 및 v2 형식의 세션 파일도 로드할 수 있으며, 저장 시에는 항상 최신 버전(v3)으로 저장합니다.

### 8.7.3 v3 스키마 정의

```json
{
    "version": 3,
    "image_path": "(문자열) 이미지 파일 경로",

    "holes": [
        {
            "id": "(정수) 조각 번호",
            "bbox": ["(정수) x", "(정수) y", "(정수) w", "(정수) h"],
            "area": "(실수) 면적",
            "contour": [["(정수) x", "(정수) y"], ...]
        }
    ],
    "svg_paths": ["(문자열) SVG path d 속성값", ...],
    "active_holes": ["(정수) 활성화된 구멍의 인덱스", ...],

    "filter_settings": {
        "(Filter Settings Dict 참조)"
    },

    "bg_regions": [
        ["(정수) x1", "(정수) y1", "(정수) x2", "(정수) y2"],
        ...
    ],
    "fg_regions": [
        ["(정수) x1", "(정수) y1", "(정수) x2", "(정수) y2"],
        ...
    ],

    "region_model": {
        "type": "(문자열) gmm 또는 single",
        "bg_components": [
            {
                "mean": ["(실수) 4차원 평균 벡터"],
                "cov_inv": [["(실수) 4x4 역공분산 행렬"]],
                "weight": "(실수) 가중치 (해당 영역 픽셀 수)"
            }
        ],
        "fg_components": ["(동일 구조)"]
    },

    "layout": {
        "paper_width": "(실수) 용지 너비 (mm)",
        "paper_height": "(실수) 용지 높이 (mm)",
        "paper_preset": "(문자열) 용지 프리셋 명칭",
        "margin": "(실수) 여백 (mm)",
        "scale_x": "(실수) X축 스케일",
        "scale_y": "(실수) Y축 스케일",
        "border_width": "(실수) 테두리 너비 (mm)",
        "spacing": "(실수) 간격 (mm)",
        "custom_scales": {
            "(정수 인덱스)": {
                "scale_x": "(실수)",
                "scale_y": "(실수)"
            }
        }
    }
}
```

### 8.7.4 버전별 하위 호환 처리

| 필드 | v1 | v2 | v3 |
|------|----|----|-----|
| version | 없음 (1로 간주) | 2 | 3 |
| bg_region (단일) | 존재 | 존재 | bg_regions 리스트로 래핑 |
| fg_region (단일) | 존재 | 존재 | fg_regions 리스트로 래핑 |
| bg_regions (다중) | 없음 | 없음 | 존재 |
| fg_regions (다중) | 없음 | 없음 | 존재 |
| region_model.type | 없음 | single | gmm |
| region_model.bg_components | 없음 | 없음 | 존재 |

## 8.8 SVG 경로 문자열 형식

### 8.8.1 명령어 체계

개별 손상 부위의 윤곽선은 SVG path의 d 속성 형식으로 표현됩니다. 사용되는 명령어는 다음과 같습니다.

| 명령어 | 의미 | 매개변수 |
|--------|------|----------|
| M | MoveTo (시작점 이동) | x, y |
| L | LineTo (직선) | x, y |
| C | CurveTo (3차 베지어 곡선) | x1, y1, x2, y2, x, y |
| Z | ClosePath (경로 닫기) | 없음 |

### 8.8.2 예시

```
M 100.0,200.0 L 150.0,200.0 L 150.0,250.0 L 100.0,250.0 Z
```

상기 경로는 좌표 (100, 200)에서 시작하여 (150, 200), (150, 250), (100, 250)을 거쳐 시작점으로 돌아오는 직사각형을 나타냅니다.
